!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery"],e):"undefined"!=typeof exports?module.exports=e(require("jquery")):e(jQuery)}(function(p){p.wwmanager={pool:[],wk_pool:[],pmax:navigator.hardwareConcurrency||10,queue:[]},p.extend(p.fn,{wwmanager:function(){var e=arguments[0],r=[].slice.call(arguments).slice(1);if(n[e])return n[e].apply(this,r);if(e){var t=l.checkAPI(p.wwmanager,e,n);p.wwmanager=t.local,n=t.API}l.startup(e,r[0],r[1],r[2],r[3])}});var n={debug:function(){console.log(p.wwmanager)},spin_up:function(e,r,t){l.spin_up(e,r,t)}},l={cmds:["wait","stop"],startup:function(e,r,t,n,a){l.spin_up(e,r,t,n,a)},id_counter:0,newID:function(){var e=new Date;return e=e.getTime()+Math.floor(2e3*Math.random()),l.id_counter++,""+(e+l.id_counter)},checkAPI:function(e,t,n){var r={};for(var a in e)if(r[a]=e[a],t.hasOwnProperty(a))if("object"==typeof r[a])if(Array.isArray(r[a])&&Array.isArray(t[a])){r[a]=[];for(var o=t[a],c=r[a],s=0;s<t[a].length;s++){var u=o[s];c.push(u)}}else"string"==typeof t[a]&&Array.isArray(r[a])?r[a].push(t[a]):r[a]=t[a];else r[a]=t[a];return p.each(n,function(e,r){null!=t[e]&&(n[e]=t[e])}),{local:r,API:n}},terminate:{_root:function(){return l},chk:function(){for(var e=this._root(),r=p.wwmanager,t=r.pool.length,n=r.queue.length,a=0;a<t;a++){for(var o=r.pool[a],c=0,s=0;s<n;s++){var u=r.queue[s];try{if(null!=o&&o.w_type==u.wk_type){c=1;break}}catch(e){console.log("[terminate.chk] error checking workers vs queue ",e,o,u)}}if(null!=o&&o.available&&0==o.persist&&0==c&&(r.pool.splice(a,1),o.terminate(),o=null),0<c){e.chk_queue();break}}},watch:!1,start:function(){0==this.watch&&(this.watch=setInterval(function(){l.terminate.chk()},100))}},get_cmd:function(e){return!("object"!=typeof e||!e.hasOwnProperty("cmd"))&&e.cmd},chk_cmds:function(e,r){for(var t=!1,n=l.cmds,a=0;a<n;a++)if(e==r&&l.cmds[a]==e){t=!0;break}return t},proc_fn:function(r,e){try{for(var t=p.wwmanager,n=r.currentTarget,a=t.queue.length,o=0;o<a;o++){var c=t.queue[o];if(c.uid==n.uid){var s=r.data,u=!e;u||s.hasOwnProperty("data")&&(s=s.data),n.success?c.fn.success(s,r):c.fn.failure(s,r),u&&t.queue.splice(o,1);break}}l.chk_queue()}catch(e){console.log("[wwmanager.methods.proc_fn] error ",e),console.log("[wwmanager.methods.proc_fn] last attempted to process ",r)}},spin_up:function(e,r,t,n,a){var o=p.wwmanager,c=function(e,r){0==r.currentTarget.nomsg&&console.log("[wwmanager.success] resp",e)},s=function(e,r){0==r.currentTarget.nomsg&&console.log("[wwmanager.failure] resp",e)};n&&(c=n),a&&(s=a),t&&(t.active=!1,t.wk_type=r,t.uid=l.newID(),t.fn={success:c,failure:s},o.queue.push(t)),e&&o.wk_pool.push({fnc:e,type:r}),(e||t)&&r?(l.chk_make_thread(),l.chk_queue(),l.terminate.start()):console.log("[wwmanager.spin_up] no inline worker or param specified, nothing to do.")},chk_make_thread:function(){var e=p.wwmanager,r=function(e){var r=e.currentTarget.w_key;"message"==e.type&&(e.currentTarget.success=!0),"error"==e.type&&(e.currentTarget.success=!1,console.log("[wwmanager.methods.worker "+r+"] error ... ",e.message),console.log("[wwmanager.methods.worker "+r+"] details ... ",e));var t=!l.chk_cmds(l.get_cmd(e.data),"wait"),n=!!l.chk_cmds(l.get_cmd(e.data),"stop");0==n&&l.proc_fn(e,t),(0==t||n)&&(e.currentTarget.available=!0,l.spin_up())};if(e.pool.length<e.pmax)for(var t=e.pool.length-1<0?0:e.pool.length-1;t<e.pmax;t++)if(0<e.wk_pool.length){var n=e.wk_pool[e.wk_pool.length-1],a=l.create_worker(n.fnc);e.wk_pool.pop(),a.w_key=t,a.w_type=n.type,a.available=!0,a.onmessage=r,a.onerror=r,e.pool.push(a)}},chk_queue:function(){for(var e=p.wwmanager,r=!1,t=e.queue.length,n=0;n<t;n++){0==(o=e.queue[n]).active&&(r=!0)}if(r){var a=!0;for(n=0;n<t;n++){var o;if(0==(o=e.queue[n]).active){var c={};for(var s in o)"function"!=typeof o[s]&&"fn"!=s&&(c[s]=o[s]);for(var u=0;u<e.pmax;u++){var i=e.pool[u];if(i.available&&i.w_type==o.wk_type){i.persist=!1,c.hasOwnProperty("persist")&&(i.persist=c.persist),i.nomsg=!1,c.hasOwnProperty("nomsg")&&(i.nomsg=c.nomsg),i.postMessage(c),i.uid=c.uid,i.available=!1,a=!(o.active=!0);break}}}}a&&setTimeout(function(){l.spin_up()},10)}},create_worker:function(e){var r=new Blob(["onmessage = (",e.toString(),")"],{type:"text/worker"}),t=URL.createObjectURL(r);return new Worker(t)}}});