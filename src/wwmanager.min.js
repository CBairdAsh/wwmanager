!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery"],e):"undefined"!=typeof exports?module.exports=e(require("jquery")):e(jQuery)}(function(e){e.wwmanager={pool:[],wk_pool:[],pmax:navigator.hardwareConcurrency||10,queue:[]},e.extend(e.fn,{wwmanager:function(){var a=arguments[0],n=[].slice.call(arguments).slice(1);if(r[a])return r[a].apply(this,n);if(a){var o=t.checkAPI(e.wwmanager,a,r);e.wwmanager=o.local,r=o.API}t.startup(a,n[0],n[1])}});var r={debug:function(){console.log(e.wwmanager)},spin_up:function(e,r,a){t.spin_up(e,r,a)}},t={cmds:["wait","stop"],startup:function(e,r,a){t.spin_up(e,r,a)},id_counter:0,newID:function(){var e=new Date;return e=e.getTime()+Math.floor(2e3*Math.random()),t.id_counter++,""+(e+t.id_counter)},checkAPI:function(r,t,a){var n={};for(var o in r)if(n[o]=r[o],t.hasOwnProperty(o))if("object"==typeof n[o])if(Array.isArray(n[o])&&Array.isArray(t[o])){n[o]=[];for(var c=t[o],s=n[o],u=0;u<t[o].length;u++){var i=c[u];s.push(i)}}else"string"==typeof t[o]&&Array.isArray(n[o])?n[o].push(t[o]):n[o]=t[o];else n[o]=t[o];return e.each(a,function(e,r){null!=t[e]&&(a[e]=t[e])}),{local:n,API:a}},terminate:{_root:function(){return t},chk:function(){for(var r=this._root(),t=e.wwmanager,a=t.pool.length,n=t.queue.length,o=0;o<a;o++){for(var c=t.pool[o],s=0,u=0;u<n;u++){var i=t.queue[u];try{if(void 0!=c&&c.w_type==i.wk_type){s=1;break}}catch(e){console.log("[terminate.chk] error checking workers vs queue ",e,c,i)}}if(void 0!=c&&c.available&&0==c.persist&&0==s&&(t.pool.splice(o,1),c.terminate(),c=null),s>0){r.chk_queue();break}}if(0==t.queue.length&&0==t.pool.length){var p=this.watch;clearInterval(p),p=!1}},watch:!1,start:function(){0==this.watch&&(this.watch=setInterval(function(){t.terminate.chk()},50))}},get_cmd:function(e){return!("object"!=typeof e||!e.hasOwnProperty("cmd"))&&e.cmd},chk_cmds:function(e,r){for(var a=!1,n=t.cmds,o=0;o<n;o++)if(e==r&&t.cmds[o]==e){a=!0;break}return a},proc_fn:function(r,t){try{for(var a=e.wwmanager,n=r.currentTarget,o=a.queue.length,c=0;c<o;c++){var s=a.queue[c];if(s.uid==n.uid){var u=r.data,i=!t;i||u.hasOwnProperty("data")&&(u=u.data),n.success?s.fn.success(u,r):s.fn.failure(u,r),i&&a.queue.splice(c,1);break}}}catch(e){console.log("[wwmanager.methods.proc_fn] error ",e),console.log("[wwmanager.methods.proc_fn] last attempted to process ",r)}},spin_up:function(r,a,n){var o=e.wwmanager;if(n){n.active=!1,n.wk_type=a;var c=function(e,r){0==r.currentTarget.nomsg&&console.log("[wwmanager.success] resp",e)},s=function(e,r){0==r.currentTarget.nomsg&&console.log("[wwmanager.failure] resp",e)};n.hasOwnProperty("fn")?(n.fn.success||(n.fn.success=c),n.fn.failure||(n.fn.failure=s)):n.fn={success:c,failure:s},n.uid=t.newID(),o.queue.push(n)}r&&o.wk_pool.push({fnc:r,type:a}),t.chk_make_thread(),t.chk_queue(),t.terminate.start()},chk_make_thread:function(){var r=e.wwmanager,a=function(e){var r=e.currentTarget.w_key;"message"==e.type&&(e.currentTarget.success=!0),"error"==e.type&&(e.currentTarget.success=!1,console.log("[wwmanager.methods.worker "+r+"] error ... ",e.message),console.log("[wwmanager.methods.worker "+r+"] details ... ",e));var a=!t.chk_cmds(t.get_cmd(e.data),"wait"),n=!!t.chk_cmds(t.get_cmd(e.data),"stop");0==n&&t.proc_fn(e,a),(0==a||n)&&(e.currentTarget.available=!0,t.spin_up())};if(r.pool.length<r.pmax)for(var n=r.pool.length-1<0?0:r.pool.length-1;n<r.pmax;n++)if(r.wk_pool.length>0){var o=r.wk_pool[r.wk_pool.length-1],c=t.create_worker(o.fnc);r.wk_pool.pop(),c.w_key=n,c.w_type=o.type,c.available=!0,c.onmessage=a,c.onerror=a,r.pool.push(c)}},chk_queue:function(){for(var r=e.wwmanager,a=!1,n=r.queue.length,o=0;o<n;o++){0==(s=r.queue[o]).active&&(a=!0)}if(a){var c=!0;for(o=0;o<n;o++){var s;if(0==(s=r.queue[o]).active){var u={};for(var i in s)"function"!=typeof s[i]&&"fn"!=i&&(u[i]=s[i]);for(var p=0;p<r.pmax;p++){var f=r.pool[p];if(f.available&&f.w_type==s.wk_type){f.persist=!1,u.hasOwnProperty("persist")&&(f.persist=u.persist),f.nomsg=!1,u.hasOwnProperty("nomsg")&&(f.nomsg=u.nomsg),f.postMessage(u),f.uid=u.uid,f.available=!1,s.active=!0,c=!1;break}}}}c&&setTimeout(function(){t.spin_up()},10)}},create_worker:function(e){var r=new Blob(["onmessage = (",e.toString(),")"],{type:"text/worker"}),t=URL.createObjectURL(r);return new Worker(t)}}});
